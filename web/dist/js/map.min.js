/**
 * @project        vera
 * @author         Dylan Viola, Hyperakt
 * @build          Mon, Feb 14, 2022 8:25 PM ET
 * @copyright      Copyright (c) 2022, 
 *
 */
"use strict";!function(C){C.VERA=C.VERA||{},VERA.mapInit=function(r){var e,a,o=this;r=null!==r?r:{},o.options=(e=r,a={zoom:!0,zoomRatio:1,zoomState:!1,populateData:function(t){o.overview.html(t.body),console.log(t.level),0===t.level||1===t.level||(2==o.markerSelect.children().length?o.nextMarkerButton.addClass("hidden"):o.nextMarkerButton.removeClass("hidden")),A(),Site.slideout()}},Object.keys(a).forEach(function(t){t in e||(e[t]=a[t])}),e),o.populateData=o.options.populateData,o.useData=function(t,e){e=e||null,o.overview.css({opacity:0}),o.populateData(t),o.overview.animate({opacity:1}),0===t.level&&w(),o.container.attr("data-level",t.level),null!==e?o.back.addClass("show"):o.back.removeClass("show"),o.currentBackTo=e};var l,c=8,d=500,u="zoomed",p=960,h=600,m=d3.select(null);this.svg=d3.select("#"+VERA.mapdata.mapid+" .project-map-svg"),this.svg.attr("width",p).attr("height",h).attr("viewBox","0 0 "+p+" "+h),this.projection=d3.geoAlbersUsa().translate([p/2,h/2]).scale([1250]),this.path=d3.geoPath().projection(o.projection),this.mapdata=VERA.mapdata.data,this.states=this.mapdata.states,this.container=$("#"+VERA.mapdata.mapid),this.mapwrap=this.container.find(".map_inner_wrap"),this.title=this.container.find(".map__title"),this.titleWrap=this.container.find(".map__title_wrap"),this.content=this.container.find(".map__content"),this.overview=this.container.find(".map__overview"),this.back=this.container.find(".back"),this.tooltip=this.container.find(".tooltip"),this.tooltiptitle=this.tooltip.find(".title"),this.tooltipsubtitle=this.tooltip.find(".subtitle"),this.loader=this.container.find(".streamloader"),this.stateSelect=this.container.find(".state_select"),this.markerSelect=this.container.find(".marker_select"),this.tempSelect=this.container.find(".map_select__temp"),this.nextMarkerButton=this.container.find(".js-marker-next"),this.stateLegend=this.container.find(".map__legend--state"),this.markerLegend=this.container.find(".map__legend--marker"),this.translate=[0,0],this.scale=1;this.init=function(){o.loader.removeClass("hidden"),d3.json("/dist/map/us.json",function(t,e){if(t)throw t;o.data=e,o.g=o.svg.append("g").attr("class","states").selectAll("path").data(topojson.feature(o.data,o.data.objects.states).features).enter().append("g").attr("class","state").append("path").attr("d",o.path).each(function(t){t.id="state_"+parseInt(t.id);for(var e=$(this),a=0,n=o.states.length,i=!1;a<n;a++)if(o.states[a].stateid==t.id){i=!0;break}var s=this.parentNode;s.setAttribute("data-state",t.properties.name),this.id=t.id,this.setAttribute("data-name",t.properties.name),this.setAttribute("data-abbr",t.properties.code),this.setAttribute("title",t.properties.name),e.addClass("state__path"),i?(t.entryId=o.states[a].entryid,t.title=t.properties.name,t.subtitle=o.states[a].subtitle,t.body=o.states[a].body,t.level=o.states[a].level,t.data=o.states[a].data,e.addClass("state__is-active"),o.states[a].toggleGroup&&(this.setAttribute("data-toggle-group",o.states[a].toggleGroup),t.toggleGroup=o.states[a].toggleGroup),o.states[a].group&&"none"!==o.states[a].group&&(s.setAttribute("in-group",""),e.addClass("state__"+o.states[a].group)),$(this).on("mouseover",function(t){(!o.options.zoom&&1024<screen.width||!o.container.hasClass(u)&&1024<screen.width)&&v(this)}),$(this).on("mouseleave",g)):e.addClass("state__is-not-active")}),o.container.find(".state[in-group]").each(function(){o.svg.select(".states").node().appendChild(this)}),VERA.mapdata.hasMarkers&&(o.markers=o.svg.append("g"),o.markers.attr("class","markers").selectAll("g").data(o.states).enter().append("g").attr("data-state",function(t){return t.title}).selectAll("path").data(function(t){return t.markers}).enter().append("g").attr("data-title",function(t){return t.title}).selectAll("path").data(function(t){return void 0!==t.dots&&t.dots}).enter().append("path").datum(function(t){var e=d3.select(this.parentNode).datum();return{type:"Point",coordinates:o.projection([t.coords.lng,t.coords.lat]),title:e.title,subtitle:t.subtitle||e.subtitle,id:e.id,group:e.group}}).attr("d",function(t){return t.coordinates?"M "+c+" 0 a "+c+" "+c+" 0 1 0 0.00001 0z":void console.warn("no coords for "+t.title)}).attr("transform",function(t){if(t.coordinates)return t.startx=t.coordinates[0],t.starty=t.coordinates[1],t.initialTransform="translate("+(t.coordinates[0]-c/2)+","+(t.coordinates[1]-c/2)+")",t.initialTransform}).attr("id",function(t){return t.id}).attr("title",function(t){return t.title}).attr("stroke-linecap","square").attr("class",function(t){return"marker marker__"+t.group}).on("mouseover",function(t){1024<screen.width&&($(o.container).find('.marker[title="'+this.getAttribute("title")+'"]').addClass("hovered"),v(this),(t=o.container.find('.markers g[data-title="'+this.getAttribute("title")+'"]').first()).parent().append(t))}).on("mouseleave",function(){1024<screen.width&&($(o.container).find('.marker[title="'+this.getAttribute("title")+'"]').removeClass("hovered"),g())}),setTimeout(_,300)),o.svg.selectAll(".state__path.state__is-active").on("click",function(){$(this).hasClass(u)?w():(o.stateSelect.val(this.id),o.stateSelect.trigger("change"))}),o.svg.selectAll(".state__path.state__is-not-active").on("click",function(){w()}),o.svg.selectAll(".marker").on("click",function(){o.markerSelect.val(this.id),o.markerSelect.trigger("change")}),o.svg.on("click",function(){}),o.back.on("click",function(){for(;o.currentBackTo;)o.goBack()}),o.nextMarkerButton.on("click",function(){$(this).blur(),o.nextMarker()}),o.stateSelectMenu=new f(o.container.find(".state_select_menu").first(),o.stateSelect),o.stateSelect.removeAttr("disabled").on("mousedown",function(t){1024<screen.width&&(t.preventDefault(),t.stopPropagation(),this.blur(),o.stateSelectMenu.toggle())}).on("click",function(t){t.stopPropagation()}).on("change",function(t){var e=$(this).val(),a=o.svg.select("#"+e);e===o.mapdata.country.entryid?o.useData(k(e)):b(a),A()}),o.markerSelectMenu=new f(o.container.find(".marker_select_menu").first(),o.markerSelect),o.markerSelect.removeAttr("disabled").on("mousedown",function(t){1024<screen.width&&(t.preventDefault(),t.stopPropagation(),this.blur(),o.markerSelectMenu.toggle())}).on("click",function(t){t.stopPropagation()}).on("change",function(){var t=$(this).val();"none"===t?o.goBack():S(o.svg.select("#"+t)),A()}),A();var a=o.mapwrap.find("svg.project-map-svg"),t=a.width(),e=a.height();a.attr("width",t).attr("height",e),C.addEventListener("resize",function(){A();var t=o.mapwrap.find("svg.project-map-svg"),e=t.width(),a=t.height();t.attr("width",e).attr("height",a)}),o.loader.addClass("hidden"),r.callback&&(o.callback=r.callback,o.callback());var n,i,s,e=document.createEvent("Event");e.initEvent("maploaded",!0,!0),C.dispatchEvent(e),o.options.zoomState&&(o.clonesvg=(e=o.svg.node(),d3.select(e.parentNode.insertBefore(e.cloneNode(!0),e.nextSibling))),n=o.clonesvg.node(),i={value:"blur(0px)"},(l=new TimelineMax({paused:!0})).to(n,d/1e3,{autoAlpha:.3}),l.to(i,d/1e3,{value:"blur(10px)",onUpdate:function(){n.style.filter=i.value}},0),C.a=l,(s=o.container.find(".project-map-svg")).each(function(t){var e=$(this);0===t&&e.find(".state__path").css({transition:"none"}),e.css({zIndex:s.length-t})}))})},this.interacted=!1,this.firstInteraction=function(){o.interacted=!0},this.goBack=function(){$(o.container).find(".marker.active").removeClass("active"),o.currentBackTo&&(void 0!==o.currentBackTo._groups?o.useData(o.currentBackTo.datum(),o.mapdata.country):o.useData(k(o.currentBackTo.entryid)))},this.nextMarker=function(){var t=o.currentMarker.node().parentNode.parentNode.firstChild.firstChild;S(d3.select(t)),o.markerSelect.val(t.id),A()},this.surfaceStates=function(t){o.container.find('.state__path[data-toggle-group="'+t+'"]').each(function(){o.svg.select(".states").node().appendChild($(this).parent()[0])})};var f=function(t,e){var a=this;this.menu=t,this.toggle=function(){a.menu.hasClass("open")?a.close():a.open()},this.open=function(){n(),a.menu.addClass("open"),$("body").one("click",a.close)},this.close=function(){a.menu.removeClass("open"),$("body").off("click",a.close)},this.initButtons=function(){a.menu.find(".map_select_button").on("click",function(){e.val(this.dataset.option),e.trigger("change"),a.close()})},this.initButtons()};function n(){o.container.find(".map_select_menu.open").removeClass("open")}function v(t){var e,a,n;1024<C.innerWidth&&(e=-1!==t.getAttribute("class").indexOf("marker")?(a=d3.select(t).datum(),n=t.getBBox(),[a.startx-c+n.width/2,a.starty-c+n.height/2]):o.path.centroid(d3.select(t).datum()),a=o.mapwrap.outerWidth()/p,n=o.mapwrap.outerHeight()/h,o.tooltip.css({top:(e[1]*o.scale+o.translate[1]-15)*n,left:(e[0]*o.scale+o.translate[0])*a}),t=d3.select(t).datum(),o.tooltiptitle.html(t.title),o.tooltipsubtitle.html(t.subtitle),!t.subtitle||"String"==typeof t.subtitle&&""===t.subtitle.strip()?o.tooltipsubtitle.addClass("hide"):o.tooltipsubtitle.removeClass("hide"),o.tooltip.addClass("show"))}function g(){o.tooltip.removeClass("show")}function k(t){if(o.mapdata.country.entryid==t)return o.mapdata.country;for(var e=0,a=(n=o.mapdata.states).length;e<a;e++){if(n[e].entryid==t)return n[e];if(Array.isArray(n[e]))for(var n=n[e],e=0,a=n.length;e<a;e++)if(n[e].entryid==t)return n[e]}return!1}function _(){var t,e,a;0<C.location.href.indexOf("selectmap=")&&(e=(t=C.location.href.split("selectmap=")[1])?t.split(":")[0]:null,t=t?t.split(":")[1]:null,e&&(b(o.svg.select("#state_"+e)),e=o.svg.node(),C.scrollTo(0,$(e).offset().top),t&&(a=o.svg.select("#marker_"+t),setTimeout(function(){S(a)},100))))}function b(t){if(o.firstInteraction(),d3.event,console.log("click"),g(),n(),m.node()&&t.node()&&(m.classed(u,!1),m.node().id===t.node().id))return o.goBack();var s=t.datum(),e=k(s.entryId);o.markerSelect.find(":not([value=none])").remove(),o.markerSelectMenu.menu.find('.map_select_button:not([data-option="none"])').parent().remove(),e.markers.forEach(function(t){o.markerSelect.append('<option value="'+t.id+'">'+t.title+"</option>"),o.markerSelectMenu.menu.append('<div class="map_select_button_wrap"><button class="map_select_button" data-option="'+t.id+'">'+t.title+"</button></div>"),o.markerSelectMenu.initButtons()}),o.markerSelect.find("option").length<=1?o.markerSelect.addClass("hide"):o.markerSelect.removeClass("hide"),m.classed(u,!1),m=t.classed(u,!0),o.options.zoom&&function(){var t=o.path.bounds(s),e=t[1][0]-t[0][0],a=t[1][1]-t[0][1],n=(t[0][0]+t[1][0])/2,t=(t[0][1]+t[1][1])/2,i=.9*o.options.zoomRatio/Math.max(e/p,a/h),t=[p/2-i*n,h/2-i*t];o.options.zoomState&&(o.svg.selectAll(".state__path").attr("opacity",0),m.attr("opacity",1),l.play());o.svg.selectAll(".states,.markers").transition().duration(d).attr("transform","translate("+t+") scale("+i+")"),o.svg.selectAll(".marker").attr("transform",function(t){if(t.initialTransform){var e="scale("+(1024<C.innerWidth?1/i:1/i*1.5)+")",a=c/i;return"translate("+(t.startx-a)+" "+(t.starty-a)+") "+e}}),o.translate=t,o.scale=i}(),o.surfaceStates(s.toggleGroup),setTimeout(function(){o.useData(s,i(s))},100);var a='.markers g[data-state="'+s.title+'"] .marker',t=$(a);$(".markers .marker").removeClass("marker__selectable"),t.addClass("marker__selectable"),e.body&&""!=e.body.trim()||t.length&&(a=d3.select(a),o.markerSelect.val(a.datum().id),setTimeout(function(){o.markerSelect.trigger("change")},100)),o.stateLegend.attr("aria-hidden",!0),o.markerLegend.attr("aria-hidden",!1),o.container.addClass(u)}function w(){o.stateSelect.val(o.stateSelect.find("option:first").val()),n(),$(".markers .marker").removeClass("marker__selectable"),m.classed(u,!1),m=d3.select(null),o.svg.selectAll(".states,.markers").transition().duration(d).attr("transform","").on("end",function(t){o.svg.selectAll(".state__path").attr("opacity",1)}),o.svg.selectAll(".marker").attr("transform",function(t){if(t.initialTransform)return t.initialTransform}),o.options.zoomState&&l.reverse(),o.container.removeClass(u),o.translate=[0,0],o.scale=1,o.stateLegend.attr("aria-hidden",!1),o.markerLegend.attr("aria-hidden",!0),A()}function S(t){d3.event&&d3.event.stopPropagation(),o.currentMarker=t;var e=d3.select(t.node().parentNode).datum(),a=$(o.container).find('.marker[title="'+t.node().getAttribute("title")+'"]');$(o.container).find(".marker.active").removeClass("active"),a.addClass("active");var n=o.container.find('.markers g[data-title="'+t.node().getAttribute("title")+'"]').first();n.parent().append(n),o.useData(e,i(e)),m.node()&&e&&(a=m.node().id.split("_")[1],t=e.id.split("_")[1],e=-1===(n=C.location.href).indexOf("?"),t=n.split("selectmap=")[0].concat((e?"?":"")+"selectmap="+a+":"+t),C.history.pushState({},"",t))}function i(t){switch(t.level){case 1:return o.mapdata.country;case 2:var e=d3.select("#"+t.id).node().parentNode.parentNode.getAttribute("data-state"),e=d3.select('.state__path[data-name="'+e+'"]');return e.datum().body?e:o.mapdata.country;default:return null}}function t(t,e,a){a=a||null,e.html(t.find("option:selected").clone()),t.hasClass("as-title")?e.addClass("as-title"):e.removeClass("as-title");var n,i=e.width();a&&(n=t.parent().outerWidth(!0)-t.parent().width(),a=a.container.outerWidth(!0)-a.select.outerWidth(!0)-n,e.outerWidth(!0)>a&&(i=a-(t.outerWidth(!0)-t.width()),t.parent(),i-=n)),$(C).width()<=768&&(i="100%"),t.width(i)}function A(){t(o.stateSelect,o.tempSelect),t(o.markerSelect,o.tempSelect)}o.init()}}(window);