/**
 * @project        vera
 * @author         Dylan Viola, Hyperakt
 * @build          Mon, Feb 14, 2022 8:25 PM ET
 * @copyright      Copyright (c) 2022, 
 *
 */
"use strict";!function(l){var c=l.VERA||{};c.makeTopX=function(e,t,n){var a,o={threshold:.35,keys:[{name:"county",weight:.5},{name:"state"},{name:"CZLabel"},{name:"alternates",weight:.4}]},r="/actions/TopX/Data/",i=this;function s(){i.queryField.on("keydown",function(e){var t;switch(e.key||e.code){case"Enter":var n=i.queryResults.find(".selected");n&&"undefined"!=n.data("id")?(d(n),i.queryField.blur()):console.log("Tried search but nothing to select");break;case"ArrowUp":(t=i.queryResults.find(".selected")).prev().length&&(t.prev().addClass("selected"),t.removeClass("selected"));break;case"ArrowDown":(t=i.queryResults.find(".selected")).next().length&&(t.next().addClass("selected"),t.removeClass("selected"));break;case"Escape":i.queryField.blur()}}).on("keyup",function(e){var n,e=e.key||e.code;-1===["Enter","ArrowUp","ArrowDown","Escape"].indexOf(e)&&(i.queryResults.empty(),""!==(e=$(this).val())&&(e=i.search.county.search(e).slice(0,10),n=!1,e.length||(e=[{name:"No Results"}],n=!0),e.forEach(function(e){var t=n?"No Results!":e.county+", "+e.state+" ("+e.CZLabel+")";i.queryResults.append('<li class="'+(e.fips?"query_result":"query_result none")+'" data-id="'+e.fips+'">'+t+"</li>")}),n||i.queryResults.children(":not(.none)").first().addClass("selected"),i.queryResults.children(":not(.none)").on("mouseover",function(){i.queryResults.find(".selected").removeClass("selected"),$(this).addClass("selected")}).on("mousedown",function(e){e.preventDefault()}).on("mouseup",function(){i.queryField.trigger("blur")}).on("click",function(e){d($(e.target))})))}).on("blur",function(e){i.queryResults.addClass("hidden")}).on("focus",function(){i.queryResults.removeClass("hidden")})}function d(e){i.queryField.val(e.text()),i.queryRow({select:i.defaultArgs.select,andWhere:{name:i.ID+' ="'+e.data("id")+'"'},columns:i.defaultArgs.columns,displayName:e.text()})}this.ID="fips",this.defaultArgs=n,this.container=$(e),this.tableWrap=this.container.find(".table_wrap"),this.tableBody=this.tableWrap.find("tbody"),this.currentLocale=this.container.find('[name="locale_type"]'),this.currentSize=this.container.find('[name="size"]'),this.loader=this.container.find(".streamloader"),this.currentLocationButton=this.container.find(".get_current_location"),this.queryField=this.container.find(".query"),this.queryResults=this.container.find(".query_results"),this.firstInteraction=function(){"undefined"!=typeof ga&&ga("send","event","topX table","first click",this.container.find(".h2").text())},(t=!Array.isArray(t)?[t]:t).forEach(function(e){e=i.container.find(e);e.find(e.data("selector")).on("change",function(){i.firstInteraction();$(this).val();var e=i.defaultArgs;i.queryResults.empty().addClass("hidden"),i.queryField.val(""),e.andWhere=e.andWhere||{},e.andWhere.size=i.currentSize.filter(":checked").val(),i.queryTable(e)})}),this.currentLocationButton.on("click",function(){i.currentLocationButton.find("span").text("Determining Location"),c.beacon=new Beacon({gmapsapikey:"AIzaSyCUEbplmckN40d3iGssxm7TX4bjW5vZ3fs",onGeocode:function(e){var t=null,n=null;e.address_components.forEach(function(e){-1!==e.types.indexOf("administrative_area_level_2")?t=e.long_name:-1!==e.types.indexOf("administrative_area_level_1")&&(n=e.short_name)}),i.county=t,i.state=n,i.container.find(".current_location").text(t+", "+n).removeClass("hidden"),i.currentLocationButton.hide();-1!==["New York County","Kings County","Queens County","Dutchess County","Bronx County"].indexOf(t)&&(t="New York City"),i.queryRow({select:i.defaultArgs.select,andWhere:{name:'county ="'+t+'" AND state ="'+n+'"'},columns:i.defaultArgs.columns,displayName:t+", "+n})}}),l.addEventListener("locationUpdated",function(){console.log(c.beacon.coords)}),c.beacon.getLocation()}),i.search={},t="/dist/data/county_lookup.json",a="county",$.getJSON({url:t}).done(function(e){i.search[a]=new Fuse(e,o),void 0===i.query&&(i.query=new s)}).fail(function(e){console.warn(e)}),this.queryTable=function(e){i.firstInteraction(),e=e||i.defaultArgs,i.loadTimer=setTimeout(function(){i.loader.removeClass("hidden"),i.container.addClass("loading")},1e3),$.ajax({method:"post",url:r+"renderTable",data:{args:e}}).done(function(e){var o=$(e).find("tr:not(.heading)"),t=$.map(o,function(e,t){e=$(e);if(0===i.tableBody.find('tr[data-id="'+e.data("id")+'"]').length)return e}),e=i.tableWrap.find("tr:not(.queried,.heading)");(e=$.map(e,function(e,t){var n=$(e),a=n;if(o.each(function(){n.data("id")===$(this).data("id")&&(a=null)}),a)return a})).forEach(function(e){$(e).remove()}),i.tableBody.append(t),i.sortTableByRank()}).fail(function(e){console.warn(e)}).always(function(){i.loadTimer&&clearTimeout(i.loadTimer),i.loader.addClass("hidden"),i.container.removeClass("loading")})},this.sortTableByRank=function(){var e=i.tableBody.find("tr:not(.heading)").get();e.sort(function(e,t){return parseFloat(e.dataset.rank)-parseFloat(t.dataset.rank)}),i.tableBody.append(e)},this.queryRow=function(e){i.firstInteraction(),$.getJSON({method:"post",url:r+"renderRow",data:{args:e}}).done(function(t){var n,e;t.error?(alert(t.error),i.queryField.focus()):(e=i.tableBody.find('[data-id="'+t.id+'"]')).length?(e.removeClass("highlight"),e[0].offsetWidth,e.addClass("highlight queried")):(n=null,i.tableBody.find("tr").each(function(){var e=Math.abs(this.dataset.rank)-t.rank;e<n&&(n=e)}),(e=$(t.content)).addClass("queried"),i.tableBody.append(e),i.sortTableByRank(),$("body").scrollTop()+$(l).height()<(e=e.offset().top+e.outerHeight(!0))+20&&$("html,body").animate({scrollTop:e-$(l).height()+20}))}).fail(function(e){console.warn(e)}).always(function(){})}}}(window);